### 一、会话机制

**`Web`程序中常用的会话跟踪技术是`Cookie`和`Session`**

**`Cookie`通过在客户端记录信息确定用户身份，`Session`通过在服务器端记录信息确定用户身份**

- 浏览器`A`给服务器发送请求，访问`web`程序，此时该次会话已经接通，不管浏览器发送多少请求，都视为一次通话，直至浏览器关闭，此次会话结束
- 若使用两个不同浏览器申请访问服务器，则视为两次不同会话

### 二、`Cookie`

#### 1. `Cookie`如何创建？如何发送给客户端？

```java
Cookie cookie = new Cookie(key,value);　　//以键值对的方式存放内容，
response.addCookie(cookie);　　//发送回浏览器端
```

**`Cookie`一旦被创建，就不可以增加其他键值对，但是可以修改其他内容**

```java
cookie.setValue();　　//将key对应的value值修改
```

#### 2. `Cookie`是如何工作的？工作原理是什么？

<img src="C:\Users\HUANGYUE\Documents\GitHub\JavaWeb\Servlet\picture\010.png" style="zoom:80%;" />

这个过程就相当于，咖啡店创建好了会员卡，并且已经设置了其中的内容，交到了客户手中，下次客户过来时，就带着会员卡过来，就知道你是会员了，然后咖啡店就拿到你的会员卡对其进行操作

#### 3. `Cookie`的有效日期

- 默认是关闭浏览器，`cookie`就没有了

- 设置保存时间

    - `expiry`：单位秒，默认 -1
    - `expiry = -1`：关闭浏览器即会话结束后，cookie失效
    - `expiry > 0`：浏览器关闭后不会失效，cookie会保存在硬盘中，直到设置时间过期才会自动删除
    - `expiry = 0`：会被浏览器删除

    ```java
    cookie.setMaxAge(expiry);
    ```

#### 4.` Cookie`使用范围

**可以在服务器端设置获取`cookie`的访问路径，而非在服务器端的`web`项目中所有的`servle`t都可以访问该`cookie`**

- 默认路径：当前访问的`servlet`父路径

    ```java
    1.例如：http://localhost:8080/test01/a/b/c/SendCookieServlet
    2.默认路径：/test01/a/b/c　　也就是说，在该默认路径下的所有Servlet都能够获取到cookie
    3./test01/a/b/c/MyServlet　这个MyServlet就能获取到cookie。
    ```

- 修改`cookie`的访问路径

    ```java
    setPath("/");	\\ 在该服务器下，任何项目，任何位置都可以获取到cookie
    ```

    **通途：保证在`tomcat`下的所有`web`项目可以共享相同的`cookie`**

#### 5. 总结

1). 工作流程

- `servlet`创建`cookie`，保存少量数据，发送浏览器

- 浏览器获得服务器发送的`cookie`数据，将自动的保存到浏览器端

- 下次访问时，浏览器将自动携带`cookie`数据发送给服务器

2). 操作

- 创建`cookie`：`new Cookie(name,value)；`
- 发送cookie到浏览器：`HttpServletResponse.addCookie(Cookie)；`
- `servlet`接收`cookie`：`HttpServletRequest.getCookies() ;`浏览器发送的所有`cookie`

3). 特点

-  每一个`cookie`文件大小：`4kb` ， 如果超过`4kb`浏览器不识别
-  一个`web`站点（`web`项目）：发送20个
- 一个浏览器保存总大小：300个
- `cookie` 不安全，可能泄露用户信息。浏览器支持禁用`cookie`操作。
- 默认情况生命周期：与浏览器会话一样，当浏览器关闭时`cookie`销毁的是临时`cookie`

4). `api`

- `getName() `获得名称，`cookie`中的`key`
- `getValue()` 获得值，`cookie`中的`value`
- `setValue(java.lang.String newValue) ` 设置内容，用于修改`key`对应的`value`值。
- `setMaxAge(int expiry)` 设置有效时间【】
- `setPath(java.lang.String uri)`  设置路径【】　　
- `setDomain(java.lang.String pattern) `设置域名 , 一般无效，有浏览器自动设置

5). 作用

- 设置`cookie`的作用范围，域名+路径在一起就构成了`cookie`的作用范围，上面单独设置的`setPath`有用，是因为有浏览器自动设置该域名属性，但是我们必须知道有这么个属性进行域名设置的
- `isHttpOnly()` ：是否只是`http`协议使用。只能`servlet`的通过`getCookies()`获得，`javascript`不能获得
- `setComment(java.lang.String purpose)` ：对该`cookie`进行描述的信息(说明作用)，浏览器显示`cookie`信息时能看到
- `setSecure(boolean flag)`：是否使用安全传输协议。为`true`时，只有当是`https`请求连接时`cookie`才会发送给服务器端，而`http`时不会，但是服务端还是可以发送给浏览端的
- `setVersion(int v)`：参数为0（传统`Netscape cookie`规范编译）或1（`RFC 2109`规范编译）

### 三、`Session`

#### 1. 作用

服务器用于共享数据技术

#### 2. Session机制

- 浏览器访问`web`站点，程序为客户端请求创建一个`session`时，服务器会检查这个客户端是否已经包含一个`session`标识（`session id`）
- 若包含，则服务器按照`session id` 检索出这个` session` 使用
- 若没有，服务器为客户端创建一个`session`并生成一个与此关联的 `session id`
- `session id`在被刺响应中返回到客户端保存
- 保存这个`session id`的方式就是`cookie`

#### 3. 获取`Session`

```java
request.getSession(); // 如果没有就创建一个新的 等效于getSession(true);
```

**为什么是通过`request`来获取`session`，可以这样理解，在获取`session`时，需要检测请求中是否有`session`标识，所以需要用`request`来获取**

```java
request.getSession(boolean); // true 没有，被创建； false 没有将返回null
```

#### 4. 属性操作

````java
// 用来存放一些信息，然后才能共享信息
setAttribute(Key,Value);
getAttribute(Key);
````

#### 5. 生命周期

**关闭浏览器不会导致`Session`被删除。服务器已经为`Session`设置了一个失效时间，一般是30分钟，当距离客户端上一次使用`Session`的时间超过这个失效时间时，服务器就可以认为客户端已经停止活动，才会把`Session`删除**

**自己设置`Session`有效时间**

````java
session.inalidate(); // 将Session对象销毁
````

```java
setMaxInactiveInterval(int interval); // 设置有效时间，单位秒
```

**在web.xml中配置**

```xml
<session-config>
	<session-timeout>30</session-timeout>
</session-config>
```

**总结：**

- 创建：第一次调用`getSession();`
- 销毁：
    - 超时，默认30分钟
    - 执行`api`，自己设置`Session`有效时间
    - 服务器非正常关闭
        - 直接将`JVM`关闭
    - 服务器正常关闭
        - `Session`会被持久化（写入到文件中）

#### 6. `Session id` 的`URL`重写

**浏览器将`cookie`禁用，`session`就无法正常工作，每次使用`request.getSession();`都将会创建一个`Session`，无法达到共享数据的目的。此时需用通过`URL`重写将`Session id`传递给服务器**

- 手动重写

- `api`方式

    ```java
    encodeURL(); // 对所有URL进行重写
    ```

    ```java
    encodeRedirectURL(); // 对URL进行重定向
    ```

    

